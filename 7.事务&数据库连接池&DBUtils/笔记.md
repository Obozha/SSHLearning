# 事物&数据库连接池&DBUtils

## 事务

> Transaction 其实指的一组操作，里面包含许多个单一的逻辑。只要一个逻辑没有执行成功，那么都算失败，所有的数据都回归到最初的状态（回滚）

* 为什么要有事务？

> 为了确保逻辑的成功，例子：银行的转账。

### 使用命令行方式演示事务

预备知识  
如何 开启 | 提交 | 回滚事务

* 开启事务
  * start transaction
* 提交 | 回滚事务
  * commit; 提交事务，数据将会写到磁盘上的数据库
  * rollback; 数据回滚，回到最初的状态。

---

操作过程

1. 关闭自动提交功能

    ```sql
    show variables like '%commit%'; // 查询自动提交状态
    set autocommit =off;            // 关闭自动提交功能
    ```

    ![01](img/01.png)
2. 演示事务

    ```sql
    start transaction; // 开启事务
    update t_student set age = age-1 where id=1; // 更新
    select * from t_student; // 查询
    rollback; // 回滚 此处也可以是commit
    ```

    ![02](img/02.png)

### 使用代码方式演示事务

> 不管是数据库还是java web的项目，都是是针对连接来的。

预备知识

1. 通过`conn.setAutoCommit(false)`来关闭自动提交的设置
2. 提交事务`conn.commit();`
3. 回滚事务`conn.rollback();`

---

```java
public static void main(String[] args) {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        try {
            conn = JDBCUtils.getConn();

            // 连接，事务默认就是自动提交的，关闭自动提交
            conn.setAutoCommit(false);

            // 扣钱，扣ID为1的100块钱
            ps = conn.prepareStatement("update account set money = money - ? where id =?");
            ps.setInt(1, 100);
            ps.setInt(2, 1);
            ps.executeUpdate();

            int a = 10 / 0; // 产生问题

            // 加钱，给ID为2 加100块钱
            ps.setInt(1, -100);
            ps.setInt(2, 2);
            ps.executeUpdate();

            // 成功：提交事务。
            conn.commit();
        } catch (Exception e) {
            try {
                // 失败，回滚事务
                conn.rollback();
            } catch (SQLException e1) {
                // TODO Auto-generated catch block
                e1.printStackTrace();
            }
            e.printStackTrace();
        } finally {
            JDBCUtils.release(conn, ps, rs);
        }
    }
```

一定要**注意，在使用事务的过程中，要更换支持事务的引擎**

MySQL默认的数据库引擎是MyIsam是不支持事务的，InnoDB支持

* MyISAM：这个是默认类型，它是基于传统的ISAM类型，ISAM是Indexed Sequential Access Method (有索引的 顺序访问方法) 的缩写，它是存储记录和文件的标准方法。与其他存储引擎比较，MyISAM具有检查和修复表格的大多数工具。 MyISAM表格可以被压缩，而且它们支持全文搜索。它们不是事务安全的，而且也不支持外键。如果事物回滚将造成不完全回滚，不具有原子性。**如果执行大量 的SELECT，MyISAM是更好的选择。**
* InnoDB：这种类型是事务安全的。它与BDB类型具有相同的特性，它们还支持外键。InnoDB表格速度很快，具有比BDB还丰富的特性，因此如果需要一个事务安全的存储引擎，建议使用它。**如果你的数据执行大量的INSERT或UPDATE**，出于性能方面的考虑，应该使用InnoDB表。

解决引擎不支持事务的办法

* 如何查看数据库表中的引擎
  * 查看数据库下所有表`show table status from db_smsystem;`
  * 查看单个表`SHOW TABLE STATUS LIKE 't_user';`
* 如何修改数据库表中的引擎
  * `ALTER TABLE t_user ENGINE=INNODB;`

![03](img/03.png)

### 事务的特性

ACID

* 原子性 - Atomicity

> 指的是，事务中包含的逻辑，不可分割

* 一致性 - Consistency

> 事务的执行使得数据库从一种正确的状态

* 隔离性 - Isolation

> 事务在执行期间不应该受到其他事务的影响

* 持久性 - Durability

> 指的是，事务执行成功，那么数据应该持久保存在磁盘上

### 事务的安全隐患

> 不考虑隔离级别设置，那么会出现以下问题。

脏读、不可重复读、幻读。

* 脏读

> 一个事务读到另一个事务还未提交的数据

